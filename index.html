<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="style.css" />
        <title>Mini Api</title>
    </head>

    <body>
    <a href="creationUser.html"><button>Créer un Utilisateur</button></a>
   
  
    <ul id="listUser">
      
    </ul>

    	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
     <script>
      $(function() {

        $(window).on('load', function(){

          $.ajax({
            url:'http://127.0.0.1:8000/lists/users', 
            type : 'GET',
            timeout : 3000,
            success: function(data){
              
              $.each(data,function(i,user){
                var idUser= String(user.id);
                //console.log(user);
                var liUser = '<li id='+idUser+' name='+user.name+' value=> name : '+user.name +' email: '+user.email+'<a> <button id='+idUser+' name="supprimerUtilisateur">Supprimer cet utilisateur</button></a> <a> <button id='+idUser+' name="ajouterTache">Ajouter une tache</button></a></li><a><button id='+idUser+' name="listerTache"> Lister les taches</button></a>';
                
                $('#listUser').append(liUser);    

            });
              
            },
            error: function(){
              alert('La requête n\'a pas abouti');
            }
          });   


        });
////////////////supprimer un utilisateur////////////////////////////
       $('ul').on("click", 'button[name="supprimerUtilisateur"]', function(){
        
                  $.ajax({
                        url:'http://127.0.0.1:8000/users/'+this.id, 
                        type : 'DELETE',
                        timeout : 3000,
                        success: function(data){
                          alert('utilisateur supprimé');
                          location.reload(true);
                        },
                        error: function(){
                          alert('La requête n\'a pas abouti');
                        }
                  });  

       });
//////////////////////////liste tout les tache pour un utilisateur/////////////////////////
       $('ul').on("click", 'button[name="listerTache"]', function(e){

           $(this).attr("disabled","disabled");
           var fermerListe = ' <a><button id='+this.id+' name="fermerTache"> Fermer la liste</button></a>'
           $(this).after(fermerListe);
                  
                  $.ajax({
                        url:'http://127.0.0.1:8000/lists/tasks/'+this.id, 
                        type : 'GET',
                        timeout : 3000,
                        success: function(data){
                          
                          $.each(data,function(i,task){
                      var idTask= String(task.id);
                      var nameUser= task.user_id.name;

                  
              
                         var liTask = '<li id='+idTask+' value='+task.user_id.id+'> title : '+task.title +' description: '+task.description+' Date de création : '+task.creation_date+' status : '+task.status+'<a> <button id='+idTask+' name="supprimerTache">Supprimer cet tache</button></a></li>';

                      
                    $('[name$='+nameUser+']').append(liTask); 

                      });

                        },
                        error: function(){
                          alert('La requête n\'a pas abouti');
                        }
                  });

                  $('ul').on("click", 'button[name="fermerTache"][id="'+this.id+'"]', function(e){

                      $('button[name="listerTache"][id="'+this.id+'"]').removeAttr("disabled");
                      $(this).remove();
                      $('li[value="'+this.id+'"]').remove()

                  });

            

       });
///////////////////supprimer une tache////////////////
$('ul').on("click", 'button[name="supprimerTache"]', function(){
                $.ajax({
                        url:'http://127.0.0.1:8000/tasks/'+this.id, 
                        type : 'DELETE',
                        timeout : 3000,
                        success: function(data){
                          alert('tache supprimée');
                          location.reload(true);
                        },
                        error: function(){
                          alert('La requête n\'a pas abouti');
                        }
                  });  
            });  


       ///////////////////ajouter une tache////////////////
$('ul').on("click", 'button[name="ajouterTache"]', function(){
    
        $(this).attr("disabled","disabled");

        var formulaire = '<div id="conteneur"><form id="formulaireTache" value="'+this.id+'" method="POST"><label for="title">Titre </label><input type="text" id="title" name="title"><br /><label for="description">Description </label><input type="text" id="description" name="description"></input><br /><label for="status">Status </label><input type="text" id="status" name="status"><br /><button type="submit" id="save">envoyer</button> <button type="button" id='+this.id+' name="annulerTache">Annuler</button></a></form><a> </div>';


      
        $(this).after(formulaire);
        var user_id = this.id;

        $('#formulaireTache[value="'+this.id+'"]').on('submit', function(e){
          var url = "index.html";
          e.preventDefault();
        
          var title = $('#title').val();
          var description = $('#description').val();
          var status = $('#status').val();
              

          var Task = {
            "title" : title,
            "description": description,
            "status": status
          };
    
          $.ajax({
            url:'http://127.0.0.1:8000/tasks/'+user_id, 
            type : 'POST',
            data: JSON.stringify(Task),
            dataType: 'json',
            contentType: 'application/json',
            success: function(data){
              console.log(data);
              alert('tache ajoutée avec succés');
              window.location.href= url;
            },
            error: function(){
              alert(" have a problem");
            }
          });


        });

        $('ul').on("click",'button[name="annulerTache"][id="'+this.id+'"]', function(){
          $('button[name="ajouterTache"][id = "'+this.id+'"]').removeAttr("disabled");
          $('#formulaireTache[value="'+this.id+'"]').remove();
        });

    });
         



        
      });
      </script>
    </body>
</html>